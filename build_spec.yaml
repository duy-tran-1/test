version: 0.1
component: build
timeoutInSeconds: 6000
shell: bash

env:
  vaultVariables:
    # <secret_name>:<secret_ocid>
    OCIR_HOST_VAULT: ocid1.vaultsecret.oc1.ap-melbourne-1.amaaaaaad2whhrqamn2d6sbexfyseljayjvofuzamxtsk2fz6wusudepbumq
    OCIR_STORAGE_NAMESPACE_VAULT: ocid1.vaultsecret.oc1.ap-melbourne-1.amaaaaaad2whhrqawqxzvdahmsnqdnv3mqzidiydfvdwowqueb4r6zd7peyq

  exportedVariables:
    - OCIR_HOST
    - OCIR_STORAGE_NAMESPACE
    - VERSION


steps:
  # Generic step
  # - type: Command
  #   name: <step_name>
  #   timeoutInSeconds: <seconds>
  #   command: |
  #     <bash_command>

  - type: Command
    name: "Extract export variables"
    timeoutInSeconds: 100
    command: |
      echo Source directory is
      echo ${OCI_PRIMARY_SOURCE_DIR}
      pwd
      export OCIR_HOST=$OCIR_HOST_VAULT
      echo OCIR_HOST is $OCIR_HOST
      export OCIR_STORAGE_NAMESPACE=$OCIR_STORAGE_NAMESPACE_VAULT
      echo OCIR_STORAGE_NAMESPACE is $OCIR_STORAGE_NAMESPACE
      export VERSION=$(date +%F)
      echo Image will be stored in ${OCIR_HOST}/${OCIR_STORAGE_NAMESPACE}/frontend-image:${YOUR_INITIALS}-${VERSION}
  

  # Build container image
  # - type: Command
  #   name: <step_name>
  #   timeoutInSeconds: <seconds>
  #   command: |
  #     docker build -t <image_location> .
  - type: Command
    timeoutInSeconds: 3600
    name: "Package"
    command: |
      echo "Packaging app"
      ./mvnw clean package

  - type: Command
    timeoutInSeconds: 3600
    name: "Dockerizer"
    command: |
      echo "Building docker image"
      docker build -t backend-test .

outputArtifacts:
  # - name: <artifact_name>           - Match this with the Build config/result artifact name in the delivery stage
  #   type: DOCKER_IMAGE or BINARY
  #   location: <image_location>      - Match this with the location in the docker build step

  - name: backend-test
    type: DOCKER_IMAGE
    location: backend-test